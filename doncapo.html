<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia: Don Capo - Role Assigner</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3561 0%, #3e2753 50%, #4a2c5e 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* RTL Support for Farsi */
        body.rtl {
            direction: rtl;
            font-family: Tahoma, 'Segoe UI', Arial, sans-serif;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 30px;
            animation: fadeIn 0.5s ease-in;
            position: relative;
            margin-top: 80px;
        }

        .back-home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 2000;
            cursor: pointer;
        }

        .back-home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Language Toggle Button */
        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            z-index: 2000;
        }

        .language-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        h1 {
            text-align: center;
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 2em;
            margin-top: 20px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .info-badge {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #dee2e6;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.4);
        }

        .roles-section {
            margin-top: 30px;
        }

        .role-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        body.rtl .role-card {
            border-left: none;
            border-right: 5px solid #667eea;
        }

        .role-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        body.rtl .role-card:hover {
            transform: translateX(-5px);
        }

        .role-card.mafia {
            border-left-color: #f5576c;
        }

        body.rtl .role-card.mafia {
            border-right-color: #f5576c;
        }

        .role-card.citizen {
            border-left-color: #4facfe;
        }

        body.rtl .role-card.citizen {
            border-right-color: #4facfe;
        }

        .player-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: 700;
            margin-right: 15px;
        }

        body.rtl .player-number {
            margin-right: 0;
            margin-left: 15px;
        }

        .role-card.mafia .player-number {
            background: #f5576c;
        }

        .role-card.citizen .player-number {
            background: #4facfe;
        }

        .role-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .role-description {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
            line-height: 1.6;
        }

        .close-game-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f5576c;
            color: white;
            border: none;
            border-radius: 20px;
            width: 70px;
            height: 36px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-game-btn:hover {
            background: #e04560;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.5);
        }

        #gameCounter {
            margin-top: 20px;
            font-size: 0.9em;
            color: #888;
            text-align: center;
            padding: 10px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-body h3 {
            color: #1a1a2e;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body h4 {
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .modal-body p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .modal-body ul {
            color: #666;
            line-height: 2;
            padding-left: 25px;
            margin-bottom: 15px;
        }

        body.rtl .modal-body ul {
            padding-left: 0;
            padding-right: 25px;
        }

        .role-help {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }

        body.rtl .role-help {
            border-left: none;
            border-right: 5px solid #667eea;
        }

        .role-help.mafia {
            border-left-color: #f5576c;
        }

        body.rtl .role-help.mafia {
            border-right-color: #f5576c;
        }

        .role-help.citizen {
            border-left-color: #4facfe;
        }

        body.rtl .role-help.citizen {
            border-right-color: #4facfe;
        }

        .team-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .team-badge.mafia {
            background: #f5576c;
            color: white;
        }

        .team-badge.citizen {
            background: #4facfe;
            color: white;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin-top: 70px;
            }

            h1 {
                font-size: 1.5em;
            }

            .language-toggle,
            .back-home-btn {
                padding: 8px 15px;
                font-size: 0.8em;
                top: 15px;
            }

            .language-toggle {
                right: 15px;
            }

            .back-home-btn {
                left: 15px;
            }

            .close-game-btn {
                width: 60px;
                height: 32px;
                font-size: 1.1em;
            }

            .close-btn {
                width: 36px;
                height: 36px;
                font-size: 1.3em;
            }

            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Global Language Toggle (Fixed Position) -->
    <button class="language-toggle" onclick="toggleLanguage()">
        <span id="langButtonText">ŸÅÿßÿ±ÿ≥€å</span>
    </button>

    <!-- Back to Home Button (Fixed Position) -->
    <a href="index.html" class="back-home-btn">
        <span>üè†</span>
        <span id="backHomeText">Back to Home</span>
    </a>

    <div class="container">
        <div id="setupSection">
            <h1 id="mainTitle">üé© Mafia: Don Capo üî´</h1>
            <p class="subtitle" id="subtitle">Role Assignment System</p>

            <div class="input-section" style="margin-bottom: 20px;">
                <label for="playerCount" style="display: block; color: #333; margin-bottom: 10px; font-weight: 600; font-size: 1.1em;">
                    <span id="playerCountLabel">Number of Players (6-20):</span>
                </label>
                <input type="number" id="playerCount" min="6" max="20" value="10" placeholder="Enter number of players"
                       style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1.1em; transition: all 0.3s ease;"
                       oninput="updatePlayerInfo()"
                       onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';"
                       onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
                <p class="error hidden" id="errorMsg" style="color: #f5576c; font-size: 0.9em; margin-top: 10px; text-align: center;"></p>
            </div>

            <div class="info-badge" id="playerInfo">
                10 Players: 3 Mafia ‚Ä¢ 7 Citizens
            </div>

            <button class="btn" onclick="startGame()">
                <span id="assignBtn">üé≤ Assign Roles</span>
            </button>
            <button class="btn btn-secondary" onclick="showHelp()">
                <span id="howToPlayBtn">üìñ How to Play</span>
            </button>
            <button class="btn btn-secondary" onclick="showFeedback()">
                <span id="feedbackBtn">üí¨ Feedback</span>
            </button>
            <div id="gameCounter">Games Played Worldwide: Loading...</div>
        </div>

        <div id="gameSection" class="hidden">
            <button class="close-game-btn" onclick="cancelGame()" title="Cancel and start over">‚úï</button>
            
            <div class="roles-section">
                <div id="rolesContainer"></div>
            </div>

            <button class="btn btn-secondary hidden" id="newGameBtn" onclick="resetGame()">
                <span id="newGameText">üîÑ New Game</span>
            </button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="helpTitle">üìñ How to Play - Don Capo</h2>
                <button class="close-btn" onclick="closeHelp()">‚úï</button>
            </div>
            <div class="modal-body" id="helpContent">
                <!-- Content will be populated by JavaScript based on language -->
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="feedbackTitle">üí¨ Send Feedback</h2>
                <button class="close-btn" onclick="closeFeedback()">‚úï</button>
            </div>
            <div class="modal-body">
                <p id="feedbackIntro" style="color: #666; margin-bottom: 20px;">Have questions, suggestions, or ideas to improve the game? We'd love to hear from you!</p>
                
                <form id="feedbackForm" onsubmit="submitFeedback(event)">
                    <div style="margin-bottom: 20px;">
                        <label for="feedbackName" id="nameLabel" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Name (Optional)</label>
                        <input type="text" id="feedbackName" placeholder="Your name" 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="feedbackEmail" id="emailLabel" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email (Optional)</label>
                        <input type="email" id="feedbackEmail" placeholder="your.email@example.com" 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="feedbackMessage" id="messageLabel" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Message *</label>
                        <textarea id="feedbackMessage" required placeholder="Share your thoughts..." 
                                  style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <p id="feedbackStatus" class="hidden" style="padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 600;"></p>
                    
                    <button type="submit" class="btn" id="submitFeedbackBtn">
                        <span id="sendBtn">üì§ Send Feedback</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmTitle" style="font-size: 1.3em;">‚ö†Ô∏è Cancel Game?</h2>
            </div>
            <div class="modal-body">
                <p id="confirmText" style="font-size: 1.1em; text-align: center; margin-bottom: 20px;">
                    Are you sure you want to cancel this game and start over?
                </p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="flex: 1;" onclick="confirmCancel()">
                        <span id="yesBtn">Yes, Cancel</span>
                    </button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeConfirm()">
                        <span id="noBtn">No, Continue</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSTuzqrJ0ik2CTfKq0GOc7lEVUYtxCX0E",
            authDomain: "spy-game-12f96.firebaseapp.com",
            databaseURL: "https://spy-game-12f96-default-rtdb.firebaseio.com",
            projectId: "spy-game-12f96",
            storageBucket: "spy-game-12f96.firebasestorage.app",
            messagingSenderId: "22301781663",
            appId: "1:22301781663:web:23f31448a872e41203fcaa",
            measurementId: "G-DE4QRR88RH"
        };

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const EMAILJS_PUBLIC_KEY = 'qw_grGhV3it_4-RwE';
        const EMAILJS_SERVICE_ID = 'service_f65c74d';
        const EMAILJS_TEMPLATE_ID = 'template_gna5het';
        
        try {
            emailjs.init(EMAILJS_PUBLIC_KEY);
        } catch (error) {
            console.error("EmailJS initialization error:", error);
        }

        // Language System
        let currentLang = localStorage.getItem('language') || 'fa';

        const translations = {
            en: {
                mainTitle: 'üé© Mafia: Don Capo üî´',
                subtitle: 'Role Assignment System',
                playerCountLabel: 'Number of Players (6-20):',
                playerInfo: '10 Players: 3 Mafia ‚Ä¢ 7 Citizens',
                assignBtn: 'üé≤ Assign Roles',
                howToPlayBtn: 'üìñ How to Play',
                feedbackBtn: 'üí¨ Feedback',
                newGameText: 'üîÑ New Game',
                langButtonText: 'ŸÅÿßÿ±ÿ≥€å',
                helpTitle: 'üìñ How to Play - Don Capo',
                feedbackTitle: 'üí¨ Send Feedback',
                feedbackIntro: 'Have questions, suggestions, or ideas to improve the game? We\'d love to hear from you!',
                nameLabel: 'Name (Optional)',
                emailLabel: 'Email (Optional)',
                messageLabel: 'Message *',
                sendBtn: 'üì§ Send Feedback',
                confirmTitle: '‚ö†Ô∏è Cancel Game?',
                confirmText: 'Are you sure you want to cancel this game and start over?',
                yesBtn: 'Yes, Cancel',
                noBtn: 'No, Continue',
                playerLabel: 'Player',
                showRoleBtn: 'üé≠ Show My Role',
                sawRoleBtn: '‚úÖ I Saw My Role',
                allAssigned: 'All Roles Assigned!',
                gameBegin: 'The game can now begin. Good luck!',
                gamesPlayed: 'Games Played Worldwide:'
            },
            fa: {
                mainTitle: 'üé© ŸÖÿßŸÅ€åÿß: ÿØŸÜ ⁄©ÿßŸæŸà üî´',
                subtitle: 'ÿ≥€åÿ≥ÿ™ŸÖ ÿ™ÿÆÿµ€åÿµ ŸÜŸÇÿ¥‚ÄåŸáÿß',
                playerCountLabel: 'ÿ™ÿπÿØÿßÿØ ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ (€∂-€≤€∞):',
                playerInfo: '€±€∞ ÿ®ÿßÿ≤€å⁄©ŸÜ: €≥ ŸÖÿßŸÅ€åÿß - €∑ ÿ¥Ÿáÿ±ŸàŸÜÿØ',
                assignBtn: 'üé≤ ÿ™ÿÆÿµ€åÿµ ŸÜŸÇÿ¥‚ÄåŸáÿß',
                howToPlayBtn: 'üìñ ÿ¢ŸÖŸàÿ≤ÿ¥ ÿ®ÿßÿ≤€å',
                feedbackBtn: 'üí¨ ÿ®ÿßÿ≤ÿÆŸàÿ±ÿØ',
                newGameText: 'üîÑ ÿ®ÿßÿ≤€å ÿ¨ÿØ€åÿØ',
                langButtonText: 'English',
                helpTitle: 'üìñ ÿ¢ŸÖŸàÿ≤ÿ¥ ÿ®ÿßÿ≤€å - ÿØŸÜ ⁄©ÿßŸæŸà',
                feedbackTitle: 'üí¨ ÿßÿ±ÿ≥ÿßŸÑ ÿ®ÿßÿ≤ÿÆŸàÿ±ÿØ',
                feedbackIntro: 'ÿ≥ŸàÿßŸÑÿå Ÿæ€åÿ¥ŸÜŸáÿßÿØ €åÿß ÿß€åÿØŸá‚Äåÿß€å ÿ®ÿ±ÿß€å ÿ®Ÿáÿ®ŸàÿØ ÿ®ÿßÿ≤€å ÿØÿßÿ±€åÿØÿü ÿÆŸàÿ¥ÿ≠ÿßŸÑ ŸÖ€å‚Äåÿ¥Ÿà€åŸÖ ŸÜÿ∏ÿ±ÿ™ÿßŸÜ ÿ±ÿß ÿ®ÿ¥ŸÜŸà€åŸÖ!',
                nameLabel: 'ŸÜÿßŸÖ (ÿßÿÆÿ™€åÿßÿ±€å)',
                emailLabel: 'ÿß€åŸÖ€åŸÑ (ÿßÿÆÿ™€åÿßÿ±€å)',
                messageLabel: 'Ÿæ€åÿßŸÖ *',
                sendBtn: 'üì§ ÿßÿ±ÿ≥ÿßŸÑ ÿ®ÿßÿ≤ÿÆŸàÿ±ÿØ',
                confirmTitle: '‚ö†Ô∏è ŸÑÿ∫Ÿà ÿ®ÿßÿ≤€åÿü',
                confirmText: 'ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ÿ®ÿßÿ≤€å ÿ±ÿß ŸÑÿ∫Ÿà ⁄©ŸÜ€åÿØ Ÿà ÿßÿ≤ ŸÜŸà ÿ¥ÿ±Ÿàÿπ ⁄©ŸÜ€åÿØÿü',
                yesBtn: 'ÿ®ŸÑŸáÿå ŸÑÿ∫Ÿà ⁄©ŸÜ',
                noBtn: 'ÿÆ€åÿ±ÿå ÿßÿØÿßŸÖŸá ÿ®ÿØŸá',
                playerLabel: 'ÿ®ÿßÿ≤€å⁄©ŸÜ',
                showRoleBtn: 'üé≠ ŸÜŸÖÿß€åÿ¥ ŸÜŸÇÿ¥ ŸÖŸÜ',
                sawRoleBtn: '‚úÖ ŸÜŸÇÿ¥ŸÖ ÿ±ÿß ÿØ€åÿØŸÖ',
                allAssigned: 'ŸáŸÖŸá ŸÜŸÇÿ¥‚ÄåŸáÿß ÿ™ÿÆÿµ€åÿµ ÿØÿßÿØŸá ÿ¥ÿØ!',
                gameBegin: 'ÿ®ÿßÿ≤€å ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥ÿ±Ÿàÿπ ÿ¥ŸàÿØ. ŸÖŸàŸÅŸÇ ÿ®ÿßÿ¥€åÿØ!',
                gamesPlayed: 'ÿ®ÿßÿ≤€å‚ÄåŸáÿß€å ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØŸá ÿØÿ± ÿ≥ÿ±ÿßÿ≥ÿ± ÿ¨ŸáÿßŸÜ:'
            }
        };

        // Role definitions
        const roles = {
            en: {
                don: {
                    name: 'Don Mafia',
                    team: 'mafia',
                    description: 'You are the Don Mafia, the leader. You always appear innocent to Detective. You have 1 antidote against poison. You decide bullet order for the Trusted (1 practice, 1 real). You can recruit Simple Citizens or Suspect to join mafia.',
                    class: 'mafia'
                },
                executioner: {
                    name: 'Executioner (Jallad)',
                    team: 'mafia',
                    description: 'You are the Executioner. Guess a player\'s exact role - if correct, they are "slaughtered" and removed from the game regardless of protection. When you use this ability, mafia cannot shoot that night.',
                    class: 'mafia'
                },
                witch: {
                    name: 'Witch (Jadoogar)',
                    team: 'mafia',
                    description: 'You are the Witch. Each night choose a citizen with an ability - their ability is reflected back on themselves (Armor Smith armors self, Herbalist poisons self, Detective investigates self showing negative). You discuss with mafia but act alone.',
                    class: 'mafia'
                },
                detective: {
                    name: 'Detective',
                    team: 'citizen',
                    description: 'You are the Detective. Each night, investigate one person to learn if they are mafia or citizen. Note: Don Mafia always shows as innocent.',
                    class: 'citizen'
                },
                armorsmith: {
                    name: 'Armor Smith',
                    team: 'citizen',
                    description: 'You are the Armor Smith. Each night, give armor to one person to protect them from attacks. You can protect yourself only once during the entire game.',
                    class: 'citizen'
                },
                herbalist: {
                    name: 'Herbalist (Attar)',
                    team: 'citizen',
                    description: 'You are the Herbalist. Each night give poison to one person. The next night, choose to cure them with antidote or let them die. You have 1 antidote in total.',
                    class: 'citizen'
                },
                heir: {
                    name: 'Heir (Vares)',
                    team: 'citizen',
                    description: 'You are the Heir. On Night 1, choose someone. If they are a citizen, you are immune to mafia shots while they live. If they die, you inherit their role but lose immunity. If you chose mafia, no benefits.',
                    class: 'citizen'
                },
                suspect: {
                    name: 'Suspect (Maznoon)',
                    team: 'citizen',
                    description: 'You are the Suspect. You are a simple citizen but appear as MAFIA to Detective investigations. If eliminated and status revealed, you are shown as citizen team. Can be recruited by Don Mafia.',
                    class: 'citizen'
                },
                citizen: {
                    name: 'Simple Citizen',
                    team: 'citizen',
                    description: 'You are a Simple Citizen. No special abilities, but your voice and vote matter. Discuss and help find the mafia! Can be recruited by Don Mafia to join their team.',
                    class: 'citizen'
                }
            },
            fa: {
                don: {
                    name: 'ÿØŸÜ ŸÖÿßŸÅ€åÿß',
                    team: 'mafia',
                    description: 'ÿ¥ŸÖÿß ÿØŸÜ ŸÖÿßŸÅ€åÿßÿå ÿ±Ÿáÿ®ÿ± ÿ™€åŸÖ Ÿáÿ≥ÿ™€åÿØ. ÿ®ÿ±ÿß€å ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ŸáŸÖ€åÿ¥Ÿá ÿ®€å‚Äå⁄ØŸÜÿßŸá ŸÜÿ¥ÿßŸÜ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥Ÿà€åÿØ. €å⁄© ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿßÿ±€åÿØ. ÿ¥ŸÖÿß ÿ™ÿ±ÿ™€åÿ® ⁄ØŸÑŸàŸÑŸá‚ÄåŸáÿß€å ŸÖÿπÿ™ŸÖÿØ ÿ±ÿß ÿ™ÿπ€å€åŸÜ ŸÖ€å‚Äå⁄©ŸÜ€åÿØ (€± ŸÖÿ¥ŸÇ€åÿå €± ÿ¨ŸÜ⁄Ø€å). ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ≥ÿßÿØŸá €åÿß ŸÖÿ∏ŸÜŸàŸÜ ÿ±ÿß ÿ®Ÿá ŸÖÿßŸÅ€åÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€åÿØ.',
                    class: 'mafia'
                },
                executioner: {
                    name: 'ÿ¨ŸÑÿßÿØ',
                    team: 'mafia',
                    description: 'ÿ¥ŸÖÿß ÿ¨ŸÑÿßÿØ Ÿáÿ≥ÿ™€åÿØ. ŸÜŸÇÿ¥ ÿØŸÇ€åŸÇ €å⁄© ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ±ÿß ÿ≠ÿØÿ≥ ÿ®ÿ≤ŸÜ€åÿØ - ÿß⁄Øÿ± ÿØÿ±ÿ≥ÿ™ ÿ®ÿßÿ¥ÿØÿå "ÿ≥ŸÑÿßÿÆ€å" ÿ¥ÿØŸá Ÿà ÿµÿ±ŸÅ ŸÜÿ∏ÿ± ÿßÿ≤ Ÿáÿ± ŸÖÿ≠ÿßŸÅÿ∏ÿ™€å ÿßÿ≤ ÿ®ÿßÿ≤€å ÿ≠ÿ∞ŸÅ ŸÖ€å‚Äåÿ¥ŸàÿØ. ŸàŸÇÿ™€å ÿßÿ≤ ÿß€åŸÜ ÿ™ŸàÿßŸÜÿß€å€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äå⁄©ŸÜ€åÿØÿå ŸÖÿßŸÅ€åÿß ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ŸáŸÖÿßŸÜ ÿ¥ÿ® ÿ¥ÿßÿ™ ÿ®ÿ≤ŸÜÿØ.',
                    class: 'mafia'
                },
                witch: {
                    name: 'ÿ¨ÿßÿØŸà⁄Øÿ±',
                    team: 'mafia',
                    description: 'ÿ¥ŸÖÿß ÿ¨ÿßÿØŸà⁄Øÿ± Ÿáÿ≥ÿ™€åÿØ. Ÿáÿ± ÿ¥ÿ® €å⁄© ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ®ÿß ÿ™ŸàÿßŸÜÿß€å€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ - ÿ™ŸàÿßŸÜÿß€å€å ÿ®Ÿá ÿÆŸàÿØÿ¥ ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿØ (ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤ ÿ®Ÿá ÿÆŸàÿØÿ¥ ÿ≤ÿ±Ÿá ŸÖ€å‚ÄåÿØŸáÿØÿå ÿπÿ∑ÿßÿ± ÿÆŸàÿØÿ¥ ÿ±ÿß ŸÖÿ≥ŸÖŸàŸÖ ŸÖ€å‚Äå⁄©ŸÜÿØÿå ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ÿÆŸàÿØÿ¥ ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ŸÖ€å‚Äå⁄©ŸÜÿØ Ÿà ŸÜÿ™€åÿ¨Ÿá ŸÖŸÜŸÅ€å ŸÖ€å‚Äåÿ¥ŸàÿØ). ÿ®ÿß ŸÖÿßŸÅ€åÿß ŸÖÿ¥Ÿàÿ±ÿ™ ŸÖ€å‚Äå⁄©ŸÜ€åÿØ ÿßŸÖÿß ÿ™ŸÜŸáÿß ÿπŸÖŸÑ ŸÖ€å‚Äå⁄©ŸÜ€åÿØ.',
                    class: 'mafia'
                },
                detective: {
                    name: '⁄©ÿßÿ±ÿ¢⁄ØÿßŸá',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá Ÿáÿ≥ÿ™€åÿØ. Ÿáÿ± ÿ¥ÿ® €å⁄© ŸÜŸÅÿ± ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åÿØ ÿ™ÿß ÿ®ŸÅŸáŸÖ€åÿØ ŸÖÿßŸÅ€åÿß €åÿß ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿßÿ≥ÿ™. ÿ™Ÿàÿ¨Ÿá: ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸáŸÖ€åÿ¥Ÿá ÿ®€å‚Äå⁄ØŸÜÿßŸá ŸÜÿ¥ÿßŸÜ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ.',
                    class: 'citizen'
                },
                armorsmith: {
                    name: 'ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤ Ÿáÿ≥ÿ™€åÿØ. Ÿáÿ± ÿ¥ÿ® ÿ®Ÿá €å⁄© ŸÜŸÅÿ± ÿ≤ÿ±Ÿá ÿ®ÿØŸá€åÿØ ÿ™ÿß ÿßÿ≤ ÿ≠ŸÖŸÑÿßÿ™ ŸÖÿ≠ÿßŸÅÿ∏ÿ™ ÿ¥ŸàÿØ. ŸÅŸÇÿ∑ €å⁄© ÿ®ÿßÿ± ÿØÿ± ⁄©ŸÑ ÿ®ÿßÿ≤€å ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿÆŸàÿØÿ™ÿßŸÜ ÿ±ÿß ŸÖÿ≠ÿßŸÅÿ∏ÿ™ ⁄©ŸÜ€åÿØ.',
                    class: 'citizen'
                },
                herbalist: {
                    name: 'ÿπÿ∑ÿßÿ±',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß ÿπÿ∑ÿßÿ± Ÿáÿ≥ÿ™€åÿØ. Ÿáÿ± ÿ¥ÿ® ÿ®Ÿá €å⁄© ŸÜŸÅÿ± ÿ≤Ÿáÿ± ÿ®ÿØŸá€åÿØ. ÿ¥ÿ® ÿ®ÿπÿØ ÿ™ÿµŸÖ€åŸÖ ÿ®⁄Ø€åÿ±€åÿØ ÿ®ÿß ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿ±ŸÖÿßŸÜÿ¥ ⁄©ŸÜ€åÿØ €åÿß ÿ®⁄Øÿ∞ÿßÿ±€åÿØ ÿ®ŸÖ€åÿ±ÿØ. ÿØÿ± ⁄©ŸÑ €± ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿßÿ±€åÿØ.',
                    class: 'citizen'
                },
                heir: {
                    name: 'Ÿàÿßÿ±ÿ´',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß Ÿàÿßÿ±ÿ´ Ÿáÿ≥ÿ™€åÿØ. ÿ¥ÿ® ÿßŸàŸÑ €å⁄© ŸÜŸÅÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ. ÿß⁄Øÿ± ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ®ÿßÿ¥ÿØÿå ÿ™ÿß ÿ≤ŸÖÿßŸÜ€å ⁄©Ÿá ÿ≤ŸÜÿØŸá ÿßÿ≥ÿ™ ÿßÿ≤ ÿ¥ÿßÿ™ ŸÖÿßŸÅ€åÿß ŸÖÿµŸàŸÜ€åÿØ. ÿß⁄Øÿ± ÿ®ŸÖ€åÿ±ÿØÿå ŸÜŸÇÿ¥ÿ¥ ÿ±ÿß ÿ®Ÿá ÿßÿ±ÿ´ ŸÖ€å‚Äåÿ®ÿ±€åÿØ ÿßŸÖÿß ŸÖÿµŸàŸÜ€åÿ™ ÿ±ÿß ÿßÿ≤ ÿØÿ≥ÿ™ ŸÖ€å‚ÄåÿØŸá€åÿØ. ÿß⁄Øÿ± ŸÖÿßŸÅ€åÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ÿ±ÿØ€åÿØÿå Ÿá€å⁄Ü ÿßŸÖÿ™€åÿßÿ≤€å ŸÜÿØÿßÿ±€åÿØ.',
                    class: 'citizen'
                },
                suspect: {
                    name: 'ŸÖÿ∏ŸÜŸàŸÜ',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß ŸÖÿ∏ŸÜŸàŸÜ Ÿáÿ≥ÿ™€åÿØ. €å⁄© ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ≥ÿßÿØŸá Ÿáÿ≥ÿ™€åÿØ ÿßŸÖÿß ÿ®ÿ±ÿß€å ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ŸÖÿßŸÅ€åÿß ŸÜÿ¥ÿßŸÜ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥Ÿà€åÿØ. ÿß⁄Øÿ± ÿ≠ÿ∞ŸÅ ÿ¥Ÿà€åÿØ Ÿà Ÿàÿ∂ÿπ€åÿ™ÿ™ÿßŸÜ ŸÅÿßÿ¥ ÿ¥ŸàÿØÿå ÿßÿ≤ ÿ™€åŸÖ ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿÆŸàÿßŸÜÿØŸá ŸÖ€å‚Äåÿ¥Ÿà€åÿØ. ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥ŸÖÿß ÿ±ÿß ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ⁄©ŸÜÿØ.',
                    class: 'citizen'
                },
                citizen: {
                    name: 'ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ≥ÿßÿØŸá',
                    team: 'citizen',
                    description: 'ÿ¥ŸÖÿß €å⁄© ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ≥ÿßÿØŸá Ÿáÿ≥ÿ™€åÿØ. ÿ™ŸàÿßŸÜÿß€å€å ÿÆÿßÿµ€å ŸÜÿØÿßÿ±€åÿØÿå ÿßŸÖÿß ÿµÿØÿß Ÿà ÿ±ÿ£€å ÿ¥ŸÖÿß ŸÖŸáŸÖ ÿßÿ≥ÿ™. ÿ®ÿ≠ÿ´ ⁄©ŸÜ€åÿØ Ÿà ÿ®Ÿá Ÿæ€åÿØÿß ⁄©ÿ±ÿØŸÜ ŸÖÿßŸÅ€åÿß ⁄©ŸÖ⁄© ⁄©ŸÜ€åÿØ! ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥ŸÖÿß ÿ±ÿß ÿ®Ÿá ÿ™€åŸÖÿ¥ ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜÿØ.',
                    class: 'citizen'
                }
            }
        };

        let currentPlayerIndex = 0;
        let playerRoles = [];
        let gameCountIncremented = false;

        function calculateTeamSize(playerCount) {
            // Don Capo dynamic role assignment (6-20 players)
            
            let don = 1; // Always have Don
            let executioner = 0, witch = 0;
            let detective = 0, armorsmith = 0, herbalist = 0, heir = 0, suspect = 0;
            
            // Assign roles based on player count thresholds
            if (playerCount >= 6) {
                armorsmith = 1;   // Core healer
                executioner = 1;  // 2nd Mafia
            }
            if (playerCount >= 7) {
                detective = 1;    // Investigation
                herbalist = 1;    // Poison role
            }
            if (playerCount >= 8) {
                heir = 1;         // Protection/inheritance
                witch = 1;        // Replace executioner with witch
                executioner = 0;
            }
            if (playerCount >= 9) {
                executioner = 1;  // Add back executioner (3 mafia now)
                suspect = 1;      // False positive
            }
            if (playerCount >= 12) {
                executioner = 2;  // 2nd Executioner (4 mafia)
            }
            if (playerCount >= 15) {
                witch = 2;        // 2nd Witch (5 mafia)
            }
            if (playerCount >= 18) {
                executioner = 3;  // 3rd Executioner (6 mafia)
            }
            
            const totalMafiaCount = don + executioner + witch;
            const totalCitizensCount = playerCount - totalMafiaCount;
            
            // Calculate simple citizens (fill remaining slots)
            const citizen = totalCitizensCount - detective - armorsmith - herbalist - heir - suspect;
            
            return {
                don: don,
                executioner: executioner,
                witch: witch,
                detective: detective,
                armorsmith: armorsmith,
                herbalist: herbalist,
                heir: heir,
                suspect: suspect,
                citizen: citizen,
                totalMafia: totalMafiaCount,
                totalCitizens: totalCitizensCount
            };
        }

        function updatePlayerInfo() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const errorMsg = document.getElementById('errorMsg');
            
            if (!playerCount || playerCount < 6 || playerCount > 20) {
                errorMsg.textContent = currentLang === 'en' 
                    ? 'Please enter a number between 6 and 20' 
                    : 'ŸÑÿ∑ŸÅÿßŸã ÿπÿØÿØ€å ÿ®€åŸÜ €∂ ÿ™ÿß €≤€∞ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            errorMsg.classList.add('hidden');
            
            const teamSize = calculateTeamSize(playerCount);
            const playerInfoEl = document.getElementById('playerInfo');
            
            if (currentLang === 'en') {
                playerInfoEl.textContent = `${playerCount} Players: ${teamSize.totalMafia} Mafia ‚Ä¢ ${teamSize.totalCitizens} Citizens`;
            } else {
                // Convert numbers to Farsi
                const persianDigits = ['€∞', '€±', '€≤', '€≥', '€¥', '€µ', '€∂', '€∑', '€∏', '€π'];
                const toFarsi = (num) => String(num).split('').map(d => persianDigits[parseInt(d)]).join('');
                playerInfoEl.textContent = `${toFarsi(playerCount)} ÿ®ÿßÿ≤€å⁄©ŸÜ: ${toFarsi(teamSize.totalMafia)} ŸÖÿßŸÅ€åÿß - ${toFarsi(teamSize.totalCitizens)} ÿ¥Ÿáÿ±ŸàŸÜÿØ`;
            }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'fa' : 'en';
            localStorage.setItem('language', currentLang);
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            document.body.className = currentLang === 'fa' ? 'rtl' : '';
            
            // Update all UI text
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('playerCountLabel').textContent = t.playerCountLabel;
            updatePlayerInfo(); // Update player info with current language
            document.getElementById('assignBtn').textContent = t.assignBtn;
            document.getElementById('howToPlayBtn').textContent = t.howToPlayBtn;
            document.getElementById('feedbackBtn').textContent = t.feedbackBtn;
            document.getElementById('newGameText').textContent = t.newGameText;
            document.getElementById('langButtonText').textContent = t.langButtonText;
            document.getElementById('helpTitle').textContent = t.helpTitle;
            document.getElementById('feedbackTitle').textContent = t.feedbackTitle;
            document.getElementById('feedbackIntro').textContent = t.feedbackIntro;
            document.getElementById('nameLabel').textContent = t.nameLabel;
            document.getElementById('emailLabel').textContent = t.emailLabel;
            document.getElementById('messageLabel').textContent = t.messageLabel;
            document.getElementById('sendBtn').textContent = t.sendBtn;
            document.getElementById('confirmTitle').textContent = t.confirmTitle;
            document.getElementById('confirmText').textContent = t.confirmText;
            document.getElementById('yesBtn').textContent = t.yesBtn;
            document.getElementById('noBtn').textContent = t.noBtn;
            
            // Update help content
            updateHelpContent();
            
            // If game is in progress, refresh the current screen
            if (playerRoles.length > 0 && !document.getElementById('gameSection').classList.contains('hidden')) {
                refreshCurrentGameScreen();
            }
        }

        function refreshCurrentGameScreen() {
            // Check if we're on the final "all assigned" screen
            if (currentPlayerIndex >= playerRoles.length) {
                const t = translations[currentLang];
                const rolesContainer = document.getElementById('rolesContainer');
                rolesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üéâ</div>
                        <h2 style="color: #333; margin-bottom: 15px;">${t.allAssigned}</h2>
                        <p style="color: #666; font-size: 1.1em;">${t.gameBegin}</p>
                    </div>
                `;
                return;
            }
            
            // Check if role is currently revealed
            const roleRevealArea = document.getElementById('roleRevealArea');
            if (roleRevealArea && roleRevealArea.innerHTML.trim() !== '') {
                // Role is revealed, refresh it
                const roleKey = playerRoles[currentPlayerIndex];
                const role = roles[currentLang][roleKey];
                const t = translations[currentLang];
                
                let teamBadge = '';
                let teamColor = '';
                if (role.team === 'mafia') {
                    teamBadge = currentLang === 'en' ? 'üòà Mafia Team' : 'üòà ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß';
                    teamColor = '#f5576c';
                } else if (role.team === 'citizen') {
                    teamBadge = currentLang === 'en' ? 'üòá Citizens Team' : 'üòá ÿ™€åŸÖ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ';
                    teamColor = '#4facfe';
                }
                
                roleRevealArea.innerHTML = `
                    <div class="role-card ${role.class}" style="margin-bottom: 20px; cursor: default;">
                        <div style="text-align: ${currentLang === 'fa' ? 'right' : 'left'};">
                            <div style="display: inline-block; background: ${teamColor}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; margin-bottom: 10px; font-weight: 600;">
                                ${teamBadge}
                            </div>
                            <div class="role-name" style="font-size: 1.8em; margin-bottom: 15px;">
                                ${role.name}
                            </div>
                            <div class="role-description" style="font-size: 1.05em; line-height: 1.8;">
                                ${role.description}
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="nextPlayer()" style="margin-top: 20px;">${t.sawRoleBtn}</button>
                `;
            } else {
                // Just the instruction screen is showing, refresh it
                const instructionBox = document.getElementById('instructionBox');
                const showRoleBtn = document.getElementById('showRoleBtn');
                if (instructionBox && showRoleBtn) {
                    const t = translations[currentLang];
                    instructionBox.innerHTML = `
                        <div style="font-size: 2.5em; margin-bottom: 15px;">üë§</div>
                        <h2 style="color: #333; margin-bottom: 10px;">${t.playerLabel} ${currentPlayerIndex + 1}</h2>
                        <p style="color: #666;">${currentLang === 'en' ? 'Click the button below to see your role' : 'ÿ±Ÿà€å ÿØ⁄©ŸÖŸá ÿ≤€åÿ± ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ ÿ™ÿß ŸÜŸÇÿ¥ ÿÆŸàÿØ ÿ±ÿß ÿ®ÿ®€åŸÜ€åÿØ'}</p>
                    `;
                    showRoleBtn.innerHTML = t.showRoleBtn;
                }
            }
        }

        function updateHelpContent() {
            const helpContent = document.getElementById('helpContent');
            
            if (currentLang === 'en') {
                helpContent.innerHTML = `
                    <h3>üéØ Game Overview</h3>
                    <p>Don Capo is a social deduction game for 10 players: 3 Mafia vs 7 Citizens. Citizens must eliminate all mafia. Mafia wins when they equal or outnumber citizens.</p>
                    
                    <h3>üåô Game Flow</h3>
                    
                    <h4>Day 1 (Introduction Day):</h4>
                    <p>Players introduce themselves. No challenges or accusations allowed. Everyone knows their role but mafia don't know each other yet.</p>
                    
                    <h4>Night 1 (Introduction Night):</h4>
                    <p>Mafia team wakes up to identify each other. Heir wakes up and chooses one person for protection/inheritance.</p>
                    
                    <h4>Day 2 Onwards:</h4>
                    <p>Players discuss and accuse. At day's end, vote for a "Trusted" (ŸÖÿπÿ™ŸÖÿØ). Trusted gets 15 seconds to speak, then chooses 2 targets. Don Mafia secretly arranges 1 practice bullet and 1 real bullet in the gun. Targets defend (30 seconds each). Trusted shoots in their chosen order. If first shot is practice, can shoot second target (cannot shoot same person twice). Trusted can also shoot in the air. The player hit by the real bullet leaves after testament, and their allegiance is announced.</p>
                    
                    <h4>Regular Days:</h4>
                    <p>Vote for suspects. Players with >50% votes go to defense. Final vote eliminates the player with most votes.</p>

                    <h3>üòà Mafia Team (3 members)</h3>
                    
                    <div class="role-help mafia">
                        <h4>üé© Don Mafia</h4>
                        <p><strong>Leader:</strong> Always shows innocent to Detective</p>
                        <p><strong>Antidote:</strong> Has 1 antidote against Herbalist's poison (if Don dies, it transfers to Witch)</p>
                        <p><strong>Bullet Order:</strong> Decides which bullet is practice and which is real for the Trusted</p>
                        <p><strong>Recruitment:</strong> Can recruit Simple Citizens or Suspect to join mafia team</p>
                    </div>

                    <div class="role-help mafia">
                        <h4>‚öîÔ∏è Executioner (Jallad)</h4>
                        <p><strong>Role Guess:</strong> Guess someone's exact role. If correct, they are "slaughtered" and removed regardless of any protection</p>
                        <p><strong>Trade-off:</strong> When Executioner uses this ability, mafia cannot shoot that night</p>
                    </div>

                    <div class="role-help mafia">
                        <h4>üîÆ Witch (Jadoogar)</h4>
                        <p><strong>Ability Reflection:</strong> Choose a citizen with an ability. Their ability reflects back on themselves:</p>
                        <ul>
                            <li>Armor Smith ‚Üí Armors themselves</li>
                            <li>Herbalist ‚Üí Poisons themselves</li>
                            <li>Detective ‚Üí Investigates themselves (result: negative/innocent)</li>
                        </ul>
                        <p><strong>Team Play:</strong> Wakes with mafia to discuss, but performs ability action alone</p>
                    </div>

                    <h3>üòá Citizens Team (7 members)</h3>
                    
                    <div class="role-help citizen">
                        <h4>üîç Detective</h4>
                        <p><strong>Investigation:</strong> Each night, investigate one player to learn if they are mafia or citizen</p>
                        <p><strong>Important:</strong> Don Mafia always shows as innocent. Suspect shows as mafia (but is actually citizen)</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üõ°Ô∏è Armor Smith</h4>
                        <p><strong>Protection:</strong> Each night, give armor to one person to protect from attacks</p>
                        <p><strong>Self-Protection:</strong> Can protect yourself only once during the entire game</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üß™ Herbalist (Attar)</h4>
                        <p><strong>Poison:</strong> Each night, give poison to one person</p>
                        <p><strong>Decision:</strong> Next night, choose to cure them with antidote or let them die</p>
                        <p><strong>Limitation:</strong> You have only 1 antidote total (Don Mafia also has 1 antidote)</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üëë Heir (Vares)</h4>
                        <p><strong>Night 1 Choice:</strong> Choose one person</p>
                        <p><strong>If Citizen:</strong> You are immune to mafia night shots while they are alive. If they die, you inherit their role but lose immunity</p>
                        <p><strong>If Mafia:</strong> No benefits whatsoever</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üé≠ Suspect (Maznoon)</h4>
                        <p><strong>False Positive:</strong> You are a citizen, but Detective investigations show you as MAFIA</p>
                        <p><strong>Reveal:</strong> If eliminated and status announced, you are shown as citizen team</p>
                        <p><strong>Recruitment:</strong> Don Mafia can recruit you to actually join the mafia team</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üë§ Simple Citizens (2 people)</h4>
                        <p><strong>Role:</strong> No special abilities</p>
                        <p><strong>Importance:</strong> Your voice and vote are crucial for finding mafia</p>
                        <p><strong>Recruitment:</strong> Don Mafia can recruit you to join the mafia team</p>
                    </div>

                    <h3>üîÑ Night Order</h3>
                    <ol>
                        <li>Mafia Team (all wake together, Witch discusses then acts alone)</li>
                        <li>Witch (performs ability reflection)</li>
                        <li>Armor Smith</li>
                        <li>Detective</li>
                        <li>Herbalist</li>
                        <li>Heir (only Night 1)</li>
                    </ol>

                    <h3>üèÜ Win Conditions</h3>
                    <ul>
                        <li><strong>Citizens Win:</strong> All mafia members eliminated</li>
                        <li><strong>Mafia Win:</strong> Mafia equal or outnumber citizens</li>
                        <li><strong>Chaos/Key Ace:</strong> When 3 players remain, they vote for a trusted who shakes hands with one player. If citizen shakes with citizen = citizens win. If citizen shakes with mafia = mafia wins. If mafia chosen as trusted = mafia wins.</li>
                    </ul>

                    <h3>üí° Strategy Tips</h3>
                    <ul>
                        <li><strong>Don:</strong> Use your recruitment wisely. Your fake innocent status is powerful.</li>
                        <li><strong>Executioner:</strong> Only guess when you're very confident - you sacrifice the mafia shot!</li>
                        <li><strong>Witch:</strong> Turning abilities against their users can devastate the citizens.</li>
                        <li><strong>Detective:</strong> Remember Don shows innocent and Suspect shows mafia (but is citizen).</li>
                        <li><strong>Heir:</strong> Choose wisely on Night 1 - your immunity depends on it!</li>
                        <li><strong>Herbalist:</strong> Your poison is powerful but you only have 1 antidote - use wisely!</li>
                    </ul>
                `;
            } else {
                helpContent.innerHTML = `
                    <h3>üéØ ŸÖÿπÿ±ŸÅ€å ÿ®ÿßÿ≤€å</h3>
                    <p>ÿØŸÜ ⁄©ÿßŸæŸà €å⁄© ÿ®ÿßÿ≤€å ÿßÿ≥ÿ™ŸÜÿ™ÿßÿ¨ ÿßÿ¨ÿ™ŸÖÿßÿπ€å ÿ®ÿ±ÿß€å €±€∞ ÿ®ÿßÿ≤€å⁄©ŸÜ ÿßÿ≥ÿ™: €≥ ŸÖÿßŸÅ€åÿß ÿØÿ± ŸÖŸÇÿßÿ®ŸÑ €∑ ÿ¥Ÿáÿ±ŸàŸÜÿØ. ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ®ÿß€åÿØ ŸáŸÖŸá ŸÖÿßŸÅ€åÿßŸáÿß ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜŸÜÿØ. ŸÖÿßŸÅ€åÿß ÿ≤ŸÖÿßŸÜ€å ÿ®ÿ±ŸÜÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ ⁄©Ÿá ÿ™ÿπÿØÿßÿØÿ¥ÿßŸÜ ÿ®ÿ±ÿßÿ®ÿ± €åÿß ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ¥ŸàÿØ.</p>
                    
                    <h3>üåô ÿ±ŸàŸÜÿØ ÿ®ÿßÿ≤€å</h3>
                    
                    <h4>ÿ±Ÿàÿ≤ ÿßŸàŸÑ (ÿ±Ÿàÿ≤ ŸÖÿπÿßÿ±ŸÅŸá):</h4>
                    <p>ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿÆŸàÿØ ÿ±ÿß ŸÖÿπÿ±ŸÅ€å ŸÖ€å‚Äå⁄©ŸÜŸÜÿØ. ⁄ÜÿßŸÑÿ¥ €åÿß ÿßÿ™ŸáÿßŸÖ ŸÖÿ¨ÿßÿ≤ ŸÜ€åÿ≥ÿ™. ŸáŸÖŸá ŸÜŸÇÿ¥ ÿÆŸàÿØ ÿ±ÿß ŸÖ€å‚ÄåÿØÿßŸÜŸÜÿØ ÿßŸÖÿß ŸÖÿßŸÅ€åÿßŸáÿß ŸáŸÜŸàÿ≤ ŸáŸÖÿØ€å⁄Øÿ± ÿ±ÿß ŸÜŸÖ€å‚Äåÿ¥ŸÜÿßÿ≥ŸÜÿØ.</p>
                    
                    <h4>ÿ¥ÿ® ÿßŸàŸÑ (ÿ¥ÿ® ŸÖÿπÿßÿ±ŸÅŸá):</h4>
                    <p>ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß ÿ®€åÿØÿßÿ± ŸÖ€å‚Äåÿ¥ŸàÿØ ÿ™ÿß ŸáŸÖÿØ€å⁄Øÿ± ÿ±ÿß ÿ¥ŸÜÿßÿ≥ÿß€å€å ⁄©ŸÜŸÜÿØ. Ÿàÿßÿ±ÿ´ ÿ®€åÿØÿßÿ± ÿ¥ÿØŸá Ÿà €å⁄© ŸÜŸÅÿ± ÿ±ÿß ÿ®ÿ±ÿß€å ŸÖÿ≠ÿßŸÅÿ∏ÿ™/ÿßÿ±ÿ´‚Äåÿ®ÿ±€å ÿßŸÜÿ™ÿÆÿßÿ® ŸÖ€å‚Äå⁄©ŸÜÿØ.</p>
                    
                    <h4>ÿ±Ÿàÿ≤ ÿØŸàŸÖ ÿ®Ÿá ÿ®ÿπÿØ:</h4>
                    <p>ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿ®ÿ≠ÿ´ Ÿà ÿßÿ™ŸáÿßŸÖ ŸÖ€å‚Äå⁄©ŸÜŸÜÿØ. ÿØÿ± Ÿæÿß€åÿßŸÜ ÿ±Ÿàÿ≤ÿå ÿ®ÿ±ÿß€å €å⁄© "ŸÖÿπÿ™ŸÖÿØ" ÿ±ÿß€å ŸÖ€å‚ÄåÿØŸáŸÜÿØ. ŸÖÿπÿ™ŸÖÿØ €±€µ ÿ´ÿßŸÜ€åŸá ÿµÿ≠ÿ®ÿ™ ŸÖ€å‚Äå⁄©ŸÜÿØÿå ÿ≥Ÿæÿ≥ €≤ ŸáÿØŸÅ ÿßŸÜÿ™ÿÆÿßÿ® ŸÖ€å‚Äå⁄©ŸÜÿØ. ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸÖÿÆŸÅ€åÿßŸÜŸá €± ⁄ØŸÑŸàŸÑŸá ŸÖÿ¥ŸÇ€å Ÿà €± ⁄ØŸÑŸàŸÑŸá ÿ¨ŸÜ⁄Ø€å ÿ±ÿß ÿØÿ± ÿ™ŸÅŸÜ⁄Ø ŸÇÿ±ÿßÿ± ŸÖ€å‚ÄåÿØŸáÿØ. ÿßŸáÿØÿßŸÅ ÿØŸÅÿßÿπ ŸÖ€å‚Äå⁄©ŸÜŸÜÿØ (Ÿáÿ± ⁄©ÿØÿßŸÖ €≥€∞ ÿ´ÿßŸÜ€åŸá). ŸÖÿπÿ™ŸÖÿØ ÿ®Ÿá ÿ™ÿ±ÿ™€åÿ® ÿßŸÜÿ™ÿÆÿßÿ®€å ÿ¥ŸÑ€å⁄© ŸÖ€å‚Äå⁄©ŸÜÿØ. ÿß⁄Øÿ± ÿ™€åÿ± ÿßŸàŸÑ ŸÖÿ¥ŸÇ€å ÿ®ÿßÿ¥ÿØÿå ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ®Ÿá ŸáÿØŸÅ ÿØŸàŸÖ ÿ¥ŸÑ€å⁄© ⁄©ŸÜÿØ (ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ®Ÿá €å⁄© ŸÜŸÅÿ± ÿØŸà ÿ®ÿßÿ± ÿ¥ŸÑ€å⁄© ⁄©ŸÜÿØ). ŸÖÿπÿ™ŸÖÿØ ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ™€åÿ± ŸáŸàÿß€å€å ŸáŸÖ ÿ®ÿ≤ŸÜÿØ. ÿ®ÿßÿ≤€å⁄©ŸÜ€å ⁄©Ÿá ÿ™€åÿ± ÿ¨ŸÜ⁄Ø€å ÿÆŸàÿ±ÿØ ÿ®ÿπÿØ ÿßÿ≤ Ÿàÿµ€åÿ™ ÿÆÿßÿ±ÿ¨ ŸÖ€å‚Äåÿ¥ŸàÿØ Ÿà ÿ≥ÿß€åÿØ ÿßŸà ÿßÿπŸÑÿßŸÖ ŸÖ€å‚Äåÿ¥ŸàÿØ.</p>
                    
                    <h4>ÿ±Ÿàÿ≤Ÿáÿß€å ÿπÿßÿØ€å:</h4>
                    <p>ÿ®ÿ±ÿß€å ŸÖÿ∏ŸÜŸàŸÜ€åŸÜ ÿ±ÿß€å ÿ®ÿØŸá€åÿØ. ÿ®ÿßÿ≤€å⁄©ŸÜÿßŸÜ ÿ®ÿß ÿ®€åÿ¥ ÿßÿ≤ €µ€∞Ÿ™ ÿ¢ÿ±ÿß ÿ®Ÿá ÿØŸÅÿßÿπ ŸÖ€å‚Äåÿ±ŸàŸÜÿØ. ÿ±ÿß€å‚Äå⁄Ø€åÿ±€å ŸÜŸáÿß€å€å ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ®ÿß ÿ®€åÿ¥ÿ™ÿ±€åŸÜ ÿ¢ÿ±ÿß ÿ±ÿß ÿ≠ÿ∞ŸÅ ŸÖ€å‚Äå⁄©ŸÜÿØ.</p>

                    <h3>üòà ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß (€≥ ÿπÿ∂Ÿà)</h3>
                    
                    <div class="role-help mafia">
                        <h4>üé© ÿØŸÜ ŸÖÿßŸÅ€åÿß</h4>
                        <p><strong>ÿ±Ÿáÿ®ÿ±:</strong> ÿ®ÿ±ÿß€å ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ŸáŸÖ€åÿ¥Ÿá ÿ®€å‚Äå⁄ØŸÜÿßŸá ŸÜÿ¥ÿßŸÜ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</p>
                        <p><strong>ŸæÿßÿØÿ≤Ÿáÿ±:</strong> €± ŸæÿßÿØÿ≤Ÿáÿ± ÿπŸÑ€åŸá ÿ≤Ÿáÿ± ÿπÿ∑ÿßÿ± ÿØÿßÿ±ÿØ (ÿß⁄Øÿ± ÿØŸÜ ÿ®ŸÖ€åÿ±ÿØÿå ÿ®Ÿá ÿ¨ÿßÿØŸà⁄Øÿ± ŸÖŸÜÿ™ŸÇŸÑ ŸÖ€å‚Äåÿ¥ŸàÿØ)</p>
                        <p><strong>ÿ™ÿ±ÿ™€åÿ® ⁄ØŸÑŸàŸÑŸá:</strong> ÿ™ÿµŸÖ€åŸÖ ŸÖ€å‚Äå⁄Ø€åÿ±ÿØ ⁄©ÿØÿßŸÖ ⁄ØŸÑŸàŸÑŸá ŸÖÿ¥ŸÇ€å Ÿà ⁄©ÿØÿßŸÖ ÿ¨ŸÜ⁄Ø€å ÿßÿ≥ÿ™ ÿ®ÿ±ÿß€å ŸÖÿπÿ™ŸÖÿØ</p>
                        <p><strong>ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:</strong> ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ≥ÿßÿØŸá €åÿß ŸÖÿ∏ŸÜŸàŸÜ ÿ±ÿß ÿ®Ÿá ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜÿØ</p>
                    </div>

                    <div class="role-help mafia">
                        <h4>‚öîÔ∏è ÿ¨ŸÑÿßÿØ</h4>
                        <p><strong>ÿ≠ÿØÿ≥ ŸÜŸÇÿ¥:</strong> ŸÜŸÇÿ¥ ÿØŸÇ€åŸÇ ⁄©ÿ≥€å ÿ±ÿß ÿ≠ÿØÿ≥ ÿ®ÿ≤ŸÜ€åÿØ. ÿß⁄Øÿ± ÿØÿ±ÿ≥ÿ™ ÿ®ÿßÿ¥ÿØÿå "ÿ≥ŸÑÿßÿÆ€å" ÿ¥ÿØŸá Ÿà ÿµÿ±ŸÅ ŸÜÿ∏ÿ± ÿßÿ≤ Ÿáÿ± ŸÖÿ≠ÿßŸÅÿ∏ÿ™€å ÿ≠ÿ∞ŸÅ ŸÖ€å‚Äåÿ¥ŸàÿØ</p>
                        <p><strong>ŸÖÿπÿßŸàÿ∂Ÿá:</strong> ŸàŸÇÿ™€å ÿ¨ŸÑÿßÿØ ÿßÿ≤ ÿß€åŸÜ ÿ™ŸàÿßŸÜÿß€å€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äå⁄©ŸÜÿØÿå ŸÖÿßŸÅ€åÿß ŸÜŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ŸáŸÖÿßŸÜ ÿ¥ÿ® ÿ¥ÿßÿ™ ÿ®ÿ≤ŸÜÿØ</p>
                    </div>

                    <div class="role-help mafia">
                        <h4>üîÆ ÿ¨ÿßÿØŸà⁄Øÿ±</h4>
                        <p><strong>ÿ®ÿßÿ≤ÿ™ÿßÿ® ÿ™ŸàÿßŸÜÿß€å€å:</strong> €å⁄© ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ®ÿß ÿ™ŸàÿßŸÜÿß€å€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ. ÿ™ŸàÿßŸÜÿß€å€å‚Äåÿ¥ÿßŸÜ ÿ®Ÿá ÿÆŸàÿØÿ¥ÿßŸÜ ÿ®ÿ±ŸÖ€å‚Äå⁄Øÿ±ÿØÿØ:</p>
                        <ul>
                            <li>ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤ ‚Üê ÿ®Ÿá ÿÆŸàÿØÿ¥ ÿ≤ÿ±Ÿá ŸÖ€å‚ÄåÿØŸáÿØ</li>
                            <li>ÿπÿ∑ÿßÿ± ‚Üê ÿÆŸàÿØÿ¥ ÿ±ÿß ŸÖÿ≥ŸÖŸàŸÖ ŸÖ€å‚Äå⁄©ŸÜÿØ</li>
                            <li>⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ‚Üê ÿÆŸàÿØÿ¥ ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ŸÖ€å‚Äå⁄©ŸÜÿØ (ŸÜÿ™€åÿ¨Ÿá: ŸÖŸÜŸÅ€å/ÿ®€å‚Äå⁄ØŸÜÿßŸá)</li>
                        </ul>
                        <p><strong>⁄©ÿßÿ± ÿ™€åŸÖ€å:</strong> ÿ®ÿß ŸÖÿßŸÅ€åÿß ÿ®€åÿØÿßÿ± ŸÖ€å‚Äåÿ¥ŸàÿØ ÿ®ÿ±ÿß€å ÿ®ÿ≠ÿ´ÿå ÿßŸÖÿß ÿ™ŸàÿßŸÜÿß€å€å ÿ±ÿß ÿ™ŸÜŸáÿß ÿßŸÜÿ¨ÿßŸÖ ŸÖ€å‚ÄåÿØŸáÿØ</p>
                    </div>

                    <h3>üòá ÿ™€åŸÖ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ (€∑ ÿπÿ∂Ÿà)</h3>
                    
                    <div class="role-help citizen">
                        <h4>üîç ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá</h4>
                        <p><strong>ÿ™ÿ≠ŸÇ€åŸÇ:</strong> Ÿáÿ± ÿ¥ÿ® €å⁄© ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åÿØ ÿ™ÿß ÿ®ŸÅŸáŸÖ€åÿØ ŸÖÿßŸÅ€åÿß €åÿß ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿßÿ≥ÿ™</p>
                        <p><strong>ŸÖŸáŸÖ:</strong> ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸáŸÖ€åÿ¥Ÿá ÿ®€å‚Äå⁄ØŸÜÿßŸá ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ. ŸÖÿ∏ŸÜŸàŸÜ ŸÖÿßŸÅ€åÿß ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ (ÿßŸÖÿß ÿØÿ± ŸàÿßŸÇÿπ ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿßÿ≥ÿ™)</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üõ°Ô∏è ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤</h4>
                        <p><strong>ŸÖÿ≠ÿßŸÅÿ∏ÿ™:</strong> Ÿáÿ± ÿ¥ÿ® ÿ®Ÿá €å⁄© ŸÜŸÅÿ± ÿ≤ÿ±Ÿá ÿ®ÿØŸá€åÿØ ÿ™ÿß ÿßÿ≤ ÿ≠ŸÖŸÑÿßÿ™ ŸÖÿ≠ÿßŸÅÿ∏ÿ™ ÿ¥ŸàÿØ</p>
                        <p><strong>ŸÖÿ≠ÿßŸÅÿ∏ÿ™ ÿ¥ÿÆÿµ€å:</strong> ŸÅŸÇÿ∑ €å⁄© ÿ®ÿßÿ± ÿØÿ± ⁄©ŸÑ ÿ®ÿßÿ≤€å ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿÆŸàÿØÿ™ÿßŸÜ ÿ±ÿß ŸÖÿ≠ÿßŸÅÿ∏ÿ™ ⁄©ŸÜ€åÿØ</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üß™ ÿπÿ∑ÿßÿ±</h4>
                        <p><strong>ÿ≤Ÿáÿ±:</strong> Ÿáÿ± ÿ¥ÿ® ÿ®Ÿá €å⁄© ŸÜŸÅÿ± ÿ≤Ÿáÿ± ÿ®ÿØŸá€åÿØ</p>
                        <p><strong>ÿ™ÿµŸÖ€åŸÖ:</strong> ÿ¥ÿ® ÿ®ÿπÿØ ÿ™ÿµŸÖ€åŸÖ ÿ®⁄Ø€åÿ±€åÿØ ÿ®ÿß ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿ±ŸÖÿßŸÜÿ¥ ⁄©ŸÜ€åÿØ €åÿß ÿ®⁄Øÿ∞ÿßÿ±€åÿØ ÿ®ŸÖ€åÿ±ÿØ</p>
                        <p><strong>ŸÖÿ≠ÿØŸàÿØ€åÿ™:</strong> ŸÅŸÇÿ∑ €± ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿßÿ±€åÿØ (ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸáŸÖ €± ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿßÿ±ÿØ)</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üëë Ÿàÿßÿ±ÿ´</h4>
                        <p><strong>ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿ® ÿßŸàŸÑ:</strong> €å⁄© ŸÜŸÅÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</p>
                        <p><strong>ÿß⁄Øÿ± ÿ¥Ÿáÿ±ŸàŸÜÿØ:</strong> ÿ™ÿß ÿ≤ŸÖÿßŸÜ€å ⁄©Ÿá ÿ≤ŸÜÿØŸá ÿßÿ≥ÿ™ ÿßÿ≤ ÿ¥ÿßÿ™ ÿ¥ÿ® ŸÖÿßŸÅ€åÿß ŸÖÿµŸàŸÜ€åÿØ. ÿß⁄Øÿ± ÿ®ŸÖ€åÿ±ÿØÿå ŸÜŸÇÿ¥ÿ¥ ÿ±ÿß ÿ®Ÿá ÿßÿ±ÿ´ ŸÖ€å‚Äåÿ®ÿ±€åÿØ ÿßŸÖÿß ŸÖÿµŸàŸÜ€åÿ™ ÿ±ÿß ÿßÿ≤ ÿØÿ≥ÿ™ ŸÖ€å‚ÄåÿØŸá€åÿØ</p>
                        <p><strong>ÿß⁄Øÿ± ŸÖÿßŸÅ€åÿß:</strong> Ÿá€å⁄Ü ÿßŸÖÿ™€åÿßÿ≤€å ŸÜÿØÿßÿ±€åÿØ</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üé≠ ŸÖÿ∏ŸÜŸàŸÜ</h4>
                        <p><strong>ŸÖÿ´ÿ®ÿ™ ⁄©ÿßÿ∞ÿ®:</strong> ÿ¥ŸÖÿß ÿ¥Ÿáÿ±ŸàŸÜÿØ Ÿáÿ≥ÿ™€åÿØÿå ÿßŸÖÿß ÿ™ÿ≠ŸÇ€åŸÇÿßÿ™ ⁄©ÿßÿ±ÿ¢⁄ØÿßŸá ÿ¥ŸÖÿß ÿ±ÿß ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ŸÖÿßŸÅ€åÿß ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ</p>
                        <p><strong>ŸÅÿßÿ¥ ÿ¥ÿØŸÜ:</strong> ÿß⁄Øÿ± ÿ≠ÿ∞ŸÅ ÿ¥Ÿà€åÿØ Ÿà Ÿàÿ∂ÿπ€åÿ™ÿ™ÿßŸÜ ÿßÿπŸÑÿßŸÖ ÿ¥ŸàÿØÿå ÿßÿ≤ ÿ™€åŸÖ ÿ¥Ÿáÿ±ŸàŸÜÿØ ŸÜÿ¥ÿßŸÜ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥Ÿà€åÿØ</p>
                        <p><strong>ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:</strong> ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥ŸÖÿß ÿ±ÿß ŸàÿßŸÇÿπÿßŸã ÿ®Ÿá ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜÿØ</p>
                    </div>

                    <div class="role-help citizen">
                        <h4>üë§ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ≥ÿßÿØŸá (€≤ ŸÜŸÅÿ±)</h4>
                        <p><strong>ŸÜŸÇÿ¥:</strong> ÿ™ŸàÿßŸÜÿß€å€å ÿÆÿßÿµ€å ŸÜÿØÿßÿ±ŸÜÿØ</p>
                        <p><strong>ÿßŸáŸÖ€åÿ™:</strong> ÿµÿØÿß Ÿà ÿ±ÿ£€å ÿ¥ŸÖÿß ÿ®ÿ±ÿß€å Ÿæ€åÿØÿß ⁄©ÿ±ÿØŸÜ ŸÖÿßŸÅ€åÿß ÿ≠€åÿßÿ™€å ÿßÿ≥ÿ™</p>
                        <p><strong>ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ:</strong> ÿØŸÜ ŸÖÿßŸÅ€åÿß ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥ŸÖÿß ÿ±ÿß ÿ®Ÿá ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜÿØ</p>
                    </div>

                    <h3>üîÑ ÿ™ÿ±ÿ™€åÿ® ÿ¥ÿ®</h3>
                    <ol>
                        <li>ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß (ŸáŸÖŸá ÿ®ÿß ŸáŸÖ ÿ®€åÿØÿßÿ± ŸÖ€å‚Äåÿ¥ŸàŸÜÿØÿå ÿ¨ÿßÿØŸà⁄Øÿ± ÿ®ÿ≠ÿ´ ŸÖ€å‚Äå⁄©ŸÜÿØ ÿ≥Ÿæÿ≥ ÿ™ŸÜŸáÿß ÿπŸÖŸÑ ŸÖ€å‚Äå⁄©ŸÜÿØ)</li>
                        <li>ÿ¨ÿßÿØŸà⁄Øÿ± (ÿ®ÿßÿ≤ÿ™ÿßÿ® ÿ™ŸàÿßŸÜÿß€å€å ÿ±ÿß ÿßŸÜÿ¨ÿßŸÖ ŸÖ€å‚ÄåÿØŸáÿØ)</li>
                        <li>ÿ≤ÿ±Ÿá‚Äåÿ≥ÿßÿ≤</li>
                        <li>⁄©ÿßÿ±ÿ¢⁄ØÿßŸá</li>
                        <li>ÿπÿ∑ÿßÿ±</li>
                        <li>Ÿàÿßÿ±ÿ´ (ŸÅŸÇÿ∑ ÿ¥ÿ® ÿßŸàŸÑ)</li>
                    </ol>

                    <h3>üèÜ ÿ¥ÿ±ÿß€åÿ∑ ÿ®ÿ±ÿØ</h3>
                    <ul>
                        <li><strong>ÿ®ÿ±ÿØ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ:</strong> ŸáŸÖŸá ÿßÿπÿ∂ÿß€å ŸÖÿßŸÅ€åÿß ÿ≠ÿ∞ŸÅ ÿ¥ŸàŸÜÿØ</li>
                        <li><strong>ÿ®ÿ±ÿØ ŸÖÿßŸÅ€åÿß:</strong> ŸÖÿßŸÅ€åÿß ÿ®ÿ±ÿßÿ®ÿ± €åÿß ÿ®€åÿ¥ÿ™ÿ± ÿßÿ≤ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ¥ŸàÿØ</li>
                        <li><strong>ÿ¢ÿ¥Ÿàÿ®/⁄©€å ÿ¢ÿ≥:</strong> ŸàŸÇÿ™€å €≥ ÿ®ÿßÿ≤€å⁄©ŸÜ ÿ®ÿßŸÇ€å ŸÖ€å‚ÄåŸÖÿßŸÜÿØÿå ÿ®ÿ±ÿß€å ŸÖÿπÿ™ŸÖÿØ ÿ±ÿß€å ŸÖ€å‚ÄåÿØŸáŸÜÿØ ⁄©Ÿá ÿ®ÿß €å⁄© ÿ®ÿßÿ≤€å⁄©ŸÜ ÿØÿ≥ÿ™ ŸÖ€å‚ÄåÿØŸáÿØ. ÿß⁄Øÿ± ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ®ÿß ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿØÿ≥ÿ™ ÿ®ÿØŸáÿØ = ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ®ÿ±ŸÜÿØŸá. ÿß⁄Øÿ± ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿ®ÿß ŸÖÿßŸÅ€åÿß ÿØÿ≥ÿ™ ÿ®ÿØŸáÿØ = ŸÖÿßŸÅ€åÿß ÿ®ÿ±ŸÜÿØŸá. ÿß⁄Øÿ± ŸÖÿßŸÅ€åÿß ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ŸÖÿπÿ™ŸÖÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ŸàÿØ = ŸÖÿßŸÅ€åÿß ÿ®ÿ±ŸÜÿØŸá.</li>
                    </ul>

                    <h3>üí° ŸÜ⁄©ÿßÿ™ ÿßÿ≥ÿ™ÿ±ÿßÿ™⁄ò€å⁄©</h3>
                    <ul>
                        <li><strong>ÿØŸÜ:</strong> ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ±ÿß ÿ®ÿß ÿØŸÇÿ™ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ. Ÿàÿ∂ÿπ€åÿ™ ÿ®€å‚Äå⁄ØŸÜÿßŸá ÿ¨ÿπŸÑ€å‚Äåÿ™ÿßŸÜ ŸÇÿØÿ±ÿ™ŸÖŸÜÿØ ÿßÿ≥ÿ™.</li>
                        <li><strong>ÿ¨ŸÑÿßÿØ:</strong> ŸÅŸÇÿ∑ ŸàŸÇÿ™€å ÿÆ€åŸÑ€å ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ÿ≠ÿØÿ≥ ÿ®ÿ≤ŸÜ€åÿØ - ÿ¥ÿßÿ™ ŸÖÿßŸÅ€åÿß ÿ±ÿß ŸÇÿ±ÿ®ÿßŸÜ€å ŸÖ€å‚Äå⁄©ŸÜ€åÿØ!</li>
                        <li><strong>ÿ¨ÿßÿØŸà⁄Øÿ±:</strong> ÿ®ÿ±⁄Øÿ±ÿØÿßŸÜÿØŸÜ ÿ™ŸàÿßŸÜÿß€å€å‚ÄåŸáÿß ÿπŸÑ€åŸá ⁄©ÿßÿ±ÿ®ÿ±ÿßŸÜÿ¥ÿßŸÜ ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ ÿ±ÿß Ÿà€åÿ±ÿßŸÜ ⁄©ŸÜÿØ.</li>
                        <li><strong>⁄©ÿßÿ±ÿ¢⁄ØÿßŸá:</strong> €åÿßÿØÿ™ÿßŸÜ ÿ®ÿßÿ¥ÿØ ÿØŸÜ ÿ®€å‚Äå⁄ØŸÜÿßŸá ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ Ÿà ŸÖÿ∏ŸÜŸàŸÜ ŸÖÿßŸÅ€åÿß ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ (ÿßŸÖÿß ÿ¥Ÿáÿ±ŸàŸÜÿØ ÿßÿ≥ÿ™).</li>
                        <li><strong>Ÿàÿßÿ±ÿ´:</strong> ÿ¥ÿ® ÿßŸàŸÑ ÿ®ÿß ÿØŸÇÿ™ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ - ŸÖÿµŸàŸÜ€åÿ™‚Äåÿ™ÿßŸÜ ÿ®Ÿá ÿ¢ŸÜ ÿ®ÿ≥ÿ™⁄Ø€å ÿØÿßÿ±ÿØ!</li>
                        <li><strong>ÿπÿ∑ÿßÿ±:</strong> ÿ≤Ÿáÿ±ÿ™ÿßŸÜ ŸÇÿØÿ±ÿ™ŸÖŸÜÿØ ÿßÿ≥ÿ™ ÿßŸÖÿß ŸÅŸÇÿ∑ €± ŸæÿßÿØÿ≤Ÿáÿ± ÿØÿßÿ±€åÿØ - ÿ®ÿß ÿØŸÇÿ™ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ!</li>
                    </ul>
                `;
            }
        }

        function startGame() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const errorMsg = document.getElementById('errorMsg');
            
            if (!playerCount || playerCount < 6 || playerCount > 20) {
                errorMsg.textContent = currentLang === 'en' 
                    ? 'Please enter a number between 6 and 20' 
                    : 'ŸÑÿ∑ŸÅÿßŸã ÿπÿØÿØ€å ÿ®€åŸÜ €∂ ÿ™ÿß €≤€∞ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            errorMsg.classList.add('hidden');
            
            const teamSize = calculateTeamSize(playerCount);
            
            // Create role array based on calculated team sizes
            let roleArray = [];
            
            // Add Mafia roles
            for (let i = 0; i < teamSize.don; i++) roleArray.push('don');
            for (let i = 0; i < teamSize.executioner; i++) roleArray.push('executioner');
            for (let i = 0; i < teamSize.witch; i++) roleArray.push('witch');
            
            // Add Citizen roles
            for (let i = 0; i < teamSize.detective; i++) roleArray.push('detective');
            for (let i = 0; i < teamSize.armorsmith; i++) roleArray.push('armorsmith');
            for (let i = 0; i < teamSize.herbalist; i++) roleArray.push('herbalist');
            for (let i = 0; i < teamSize.heir; i++) roleArray.push('heir');
            for (let i = 0; i < teamSize.suspect; i++) roleArray.push('suspect');
            for (let i = 0; i < teamSize.citizen; i++) roleArray.push('citizen');
            
            // Shuffle and assign
            playerRoles = shuffleArray(roleArray);
            currentPlayerIndex = 0;
            
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('gameSection').classList.remove('hidden');
            
            // Hide back-to-home button during game
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'none';
            
            showPlayerReveal();
        }

        function showPlayerReveal() {
            const rolesContainer = document.getElementById('rolesContainer');
            const newGameBtn = document.getElementById('newGameBtn');
            const t = translations[currentLang];
            
            if (currentPlayerIndex >= playerRoles.length) {
                if (!gameCountIncremented) {
                    incrementGlobalCounter();
                    gameCountIncremented = true;
                }
                
                rolesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üéâ</div>
                        <h2 style="color: #333; margin-bottom: 15px;">${t.allAssigned}</h2>
                        <p style="color: #666; font-size: 1.1em;">${t.gameBegin}</p>
                    </div>
                `;
                newGameBtn.classList.remove('hidden');
                return;
            }
            
            newGameBtn.classList.add('hidden');
            
            rolesContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div id="instructionBox" style="background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 20px;">
                        <div style="font-size: 2.5em; margin-bottom: 15px;">üë§</div>
                        <h2 style="color: #333; margin-bottom: 10px;">${t.playerLabel} ${currentPlayerIndex + 1}</h2>
                        <p style="color: #666;">${currentLang === 'en' ? 'Click the button below to see your role' : 'ÿ±Ÿà€å ÿØ⁄©ŸÖŸá ÿ≤€åÿ± ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ ÿ™ÿß ŸÜŸÇÿ¥ ÿÆŸàÿØ ÿ±ÿß ÿ®ÿ®€åŸÜ€åÿØ'}</p>
                    </div>
                    
                    <div id="roleRevealArea"></div>
                    
                    <button class="btn" id="showRoleBtn" onclick="revealRole()">${t.showRoleBtn}</button>
                </div>
            `;
        }

        function revealRole() {
            document.getElementById('instructionBox').style.display = 'none';
            document.getElementById('showRoleBtn').style.display = 'none';
            
            const roleKey = playerRoles[currentPlayerIndex];
            const role = roles[currentLang][roleKey];
            const t = translations[currentLang];
            
            let teamBadge = '';
            let teamColor = '';
            if (role.team === 'mafia') {
                teamBadge = currentLang === 'en' ? 'üòà Mafia Team' : 'üòà ÿ™€åŸÖ ŸÖÿßŸÅ€åÿß';
                teamColor = '#f5576c';
            } else if (role.team === 'citizen') {
                teamBadge = currentLang === 'en' ? 'üòá Citizens Team' : 'üòá ÿ™€åŸÖ ÿ¥Ÿáÿ±ŸàŸÜÿØÿßŸÜ';
                teamColor = '#4facfe';
            }
            
            const roleRevealArea = document.getElementById('roleRevealArea');
            roleRevealArea.innerHTML = `
                <div class="role-card ${role.class}" style="margin-bottom: 20px; cursor: default;">
                    <div style="text-align: ${currentLang === 'fa' ? 'right' : 'left'};">
                        <div style="display: inline-block; background: ${teamColor}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; margin-bottom: 10px; font-weight: 600;">
                            ${teamBadge}
                        </div>
                        <div class="role-name" style="font-size: 1.8em; margin-bottom: 15px;">
                            ${role.name}
                        </div>
                        <div class="role-description" style="font-size: 1.05em; line-height: 1.8;">
                            ${role.description}
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="nextPlayer()" style="margin-top: 20px;">${t.sawRoleBtn}</button>
            `;
        }

        function nextPlayer() {
            currentPlayerIndex++;
            showPlayerReveal();
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function resetGame() {
            currentPlayerIndex = 0;
            playerRoles = [];
            gameCountIncremented = false;
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('gameSection').classList.add('hidden');
            document.getElementById('rolesContainer').innerHTML = '';
            document.getElementById('newGameBtn').classList.add('hidden');
            
            // Show back-to-home button when returning to setup
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'inline-flex';
        }

        function cancelGame() {
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function confirmCancel() {
            closeConfirm();
            resetGame();
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        function showHelp() {
            document.getElementById('helpModal').classList.remove('hidden');
            // Hide back-to-home button when showing help
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'none';
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.add('hidden');
            // Show back-to-home button when closing help
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'inline-flex';
        }

        function showFeedback() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            // Hide back-to-home button when showing feedback
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'none';
        }

        function closeFeedback() {
            document.getElementById('feedbackModal').classList.add('hidden');
            // Show back-to-home button when closing feedback
            const backHomeBtn = document.querySelector('.back-home-btn');
            if (backHomeBtn) backHomeBtn.style.display = 'inline-flex';
            setTimeout(() => {
                document.getElementById('feedbackForm').reset();
                document.getElementById('feedbackStatus').classList.add('hidden');
            }, 300);
        }

        function updateGlobalCounter() {
            if (!database) {
                const t = translations[currentLang];
                document.getElementById('gameCounter').textContent = t.gamesPlayed + ' ' + (currentLang === 'en' ? 'Setup Required' : 'ŸÜ€åÿßÿ≤ ÿ®Ÿá ÿ™ŸÜÿ∏€åŸÖ');
                return;
            }

            const counterRef = database.ref('donCapoGameCounter');
            counterRef.on('value', (snapshot) => {
                const count = snapshot.val() || 0;
                const t = translations[currentLang];
                document.getElementById('gameCounter').textContent = t.gamesPlayed + ' ' + count.toLocaleString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
            });
        }

        function incrementGlobalCounter() {
            if (!database) return;

            const counterRef = database.ref('donCapoGameCounter');
            counterRef.transaction((currentValue) => {
                return (currentValue || 0) + 1;
            });
        }

        function submitFeedback(event) {
            event.preventDefault();
            
            const name = document.getElementById('feedbackName').value.trim();
            const email = document.getElementById('feedbackEmail').value.trim();
            const message = document.getElementById('feedbackMessage').value.trim();
            const submitBtn = document.getElementById('submitFeedbackBtn');
            const statusEl = document.getElementById('feedbackStatus');
            
            if (!message) {
                statusEl.textContent = currentLang === 'en' ? '‚ö†Ô∏è Please enter a message' : '‚ö†Ô∏è ŸÑÿ∑ŸÅÿßŸã Ÿæ€åÿßŸÖ€å Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                statusEl.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            const sendingText = currentLang === 'en' ? 'üì§ Sending...' : 'üì§ ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ±ÿ≥ÿßŸÑ...';
            submitBtn.querySelector('span').textContent = sendingText;
            
            if (database) {
                const counterRef = database.ref('donCapoFeedbackCounter');
                counterRef.transaction((currentValue) => {
                    return (currentValue || 0) + 1;
                }).then((result) => {
                    const feedbackNumber = result.snapshot.val();
                    
                    const feedbackRef = database.ref('donCapoFeedback');
                    return feedbackRef.push({
                        number: feedbackNumber,
                        name: name || 'Anonymous',
                        email: email || 'Not provided',
                        message: message,
                        language: currentLang,
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleString()
                    }).then(() => feedbackNumber);
                })
                .then((feedbackNumber) => {
                    if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
                        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                            feedback_number: feedbackNumber,
                            from_name: name || 'Anonymous',
                            from_email: email || 'Not provided',
                            message: message + '\n\nGame: Don Capo\nLanguage: ' + currentLang,
                            to_email: 'contact.ehm@gmail.com'
                        }).catch((error) => {
                            console.error('EmailJS error:', error);
                        });
                    }
                    
                    statusEl.textContent = currentLang === 'en' ? '‚úÖ Thank you! Your feedback has been sent successfully!' : '‚úÖ ŸÖÿ™ÿ¥⁄©ÿ±€åŸÖ! ÿ®ÿßÿ≤ÿÆŸàÿ±ÿØ ÿ¥ŸÖÿß ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ!';
                    statusEl.style.background = '#d4edda';
                    statusEl.style.color = '#155724';
                    statusEl.classList.remove('hidden');
                    
                    document.getElementById('feedbackForm').reset();
                    
                    setTimeout(() => {
                        closeFeedback();
                    }, 2000);
                })
                .catch((error) => {
                    console.error('Error submitting feedback:', error);
                    statusEl.textContent = currentLang === 'en' ? '‚ùå Error sending feedback. Please try again.' : '‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ≥ÿßŸÑ ÿ®ÿßÿ≤ÿÆŸàÿ±ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.';
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                    statusEl.classList.remove('hidden');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.querySelector('span').textContent = translations[currentLang].sendBtn;
                });
            } else {
                statusEl.textContent = currentLang === 'en' ? '‚ùå Firebase not configured.' : '‚ùå Firebase Ÿæ€å⁄©ÿ±ÿ®ŸÜÿØ€å ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™.';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                statusEl.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = translations[currentLang].sendBtn;
            }
        }

        // Close modals when clicking outside
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('helpModal').addEventListener('click', function(e) {
                if (e.target === this) closeHelp();
            });
            
            document.getElementById('feedbackModal').addEventListener('click', function(e) {
                if (e.target === this) closeFeedback();
            });
            
            document.getElementById('confirmModal').addEventListener('click', function(e) {
                if (e.target === this) closeConfirm();
            });

            // Initialize
            updateLanguage();
            updateGlobalCounter();
        });
    </script>
</body>
</html>

